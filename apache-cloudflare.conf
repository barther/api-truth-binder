<VirtualHost *:80>
    ServerName noc.arther.co

    # Redirect to HTTPS
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}$1 [R=301,L]
</VirtualHost>

<VirtualHost *:443>
    ServerName noc.arther.co

    # Cloudflare SSL Certificates
    SSLEngine on
    SSLCertificateFile      /etc/ssl/certs/cloudflare_origin.pem
    SSLCertificateKeyFile   /etc/ssl/certs/cloudflare_private.pem
    SSLCertificateChainFile /etc/ssl/certs/origin_ca_rsa_root.pem

    # Cloudflare real IP (so you see actual visitor IPs, not Cloudflare's)
    RemoteIPHeader CF-Connecting-IP
    RemoteIPTrustedProxy 173.245.48.0/20
    RemoteIPTrustedProxy 103.21.244.0/22
    RemoteIPTrustedProxy 103.22.200.0/22
    RemoteIPTrustedProxy 103.31.4.0/22
    RemoteIPTrustedProxy 141.101.64.0/18
    RemoteIPTrustedProxy 108.162.192.0/18
    RemoteIPTrustedProxy 190.93.240.0/20
    RemoteIPTrustedProxy 188.114.96.0/20
    RemoteIPTrustedProxy 197.234.240.0/22
    RemoteIPTrustedProxy 198.41.128.0/17
    RemoteIPTrustedProxy 162.158.0.0/15
    RemoteIPTrustedProxy 104.16.0.0/13
    RemoteIPTrustedProxy 104.24.0.0/14
    RemoteIPTrustedProxy 172.64.0.0/13
    RemoteIPTrustedProxy 131.0.72.0/22

    # Reverse proxy to Node app
    ProxyPreserveHost On
    ProxyPass / http://localhost:3001/
    ProxyPassReverse / http://localhost:3001/

    # WebSocket support
    RewriteEngine On
    RewriteCond %{HTTP:Upgrade} =websocket [NC]
    RewriteRule /(.*)           ws://localhost:3001/$1 [P,L]

    # Logging
    ErrorLog ${APACHE_LOG_DIR}/noc-error.log
    CustomLog ${APACHE_LOG_DIR}/noc-access.log combined
</VirtualHost>
